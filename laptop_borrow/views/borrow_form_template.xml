<odoo>
  <template id="borrow_form_template" name="Borrow Laptop Form">
    <t t-call="website.layout">
      <t t-call-assets="web.assets_frontend"/>
      <t t-call-assets="laptop_borrow.assets_frontend"/>

      <div class="container mt-5 mb-5">
        <h2>Form Peminjaman Laptop</h2>
        <form id="borrow-form" action="/form/peminjaman/submit" method="post">

          <!-- KELAS -->
          <div class="form-group mt-2">
            <label>Kelas</label>
            <select id="class_id" name="class_id" class="form-control" required="required">
              <option value="">-- Pilih Kelas --</option>
              <t t-foreach="kelas" t-as="k">
                <option t-att-value="k.id"><t t-esc="k.name"/></option>
              </t>
            </select>
          </div>

          <!-- NAMA SISWA -->
          <div class="form-group mt-2">
            <label>Nama Peminjam</label>
            <select id="borrower_id" name="borrower_id" class="form-control" required="required">
              <option value="">-- Pilih Nama --</option>
            </select>
          </div>

          <!-- LAPTOP -->
          <div class="form-group mt-2">
            <label>Laptop</label>
            <select name="laptop_id" class="form-control" required="required">
              <t t-foreach="laptop" t-as="l">
                <option t-att-value="l.id"><t t-esc="l.name"/></option>
              </t>
            </select>
          </div>

          <!-- TUJUAN -->
          <div class="form-group mt-2">
            <label>Tujuan Peminjaman</label>
            <select name="tujuan_peminjaman" id="tujuan_peminjaman" class="form-control" required="required">
              <option value="">-- Pilih Tujuan --</option>
              <option value="kbm">KBM</option>
              <option value="lainnya">Lainnya</option>
            </select>
          </div>

          <!-- GURU MAPEL -->
          <div class="form-group mt-2" id="mapel_field" style="display:none;">
            <label>Guru Mata Pelajaran</label>
            <input type="text" name="guru_mapel" class="form-control"/>
          </div>

          <!-- KETERANGAN -->
          <div class="form-group mt-2" id="keterangan_field" style="display:none;">
            <label>Keterangan</label>
            <textarea name="keterangan" class="form-control"></textarea>
          </div>

          <!-- JUMLAH -->
          <div class="form-group mt-2">
            <label>Jumlah Laptop</label>
            <input type="number" name="jumlah_pinjam" class="form-control" value="1" min="1"/>
          </div>

          <!-- PETUGAS -->
          <div class="form-group mt-2">
            <label>Petugas</label>
            <input type="text" name="petugas_jaga" class="form-control"/>
          </div>

          <!-- TANGGAL -->
          <div class="form-group mt-2">
            <label>Tanggal Peminjaman</label>
            <input type="date" name="borrow_date" class="form-control" required="required"/>
          </div>

          <button type="submit" class="btn btn-primary mt-3">Kirim</button>
        </form>
      </div>

      <!-- ===================== SCRIPT SECTION ===================== -->
      <script>
      document.addEventListener('DOMContentLoaded', function() {
          const classSelect = document.getElementById('class_id');
          const studentSelect = document.getElementById('borrower_id');
          const tujuanSelect = document.getElementById('tujuan_peminjaman');
          const mapelField = document.getElementById('mapel_field');
          const ketField = document.getElementById('keterangan_field');

          // --- AJAX load siswa berdasarkan kelas ---
          classSelect.addEventListener('change', async function() {
              const classId = this.value;
              studentSelect.innerHTML = '<option value="">-- Memuat... --</option>';

              if (classId) {
                  try {
                      const response = await fetch('/get_students_by_class', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({ class_id: classId })
                      });

                      const students = await response.json();
                      studentSelect.innerHTML = '<option value="">-- Pilih Nama --</option>';

                      if (students.length > 0) {
                          students.forEach(s => {
                              const opt = document.createElement('option');
                              opt.value = s.id;
                              opt.textContent = s.name;
                              studentSelect.appendChild(opt);
                          });
                      } else {
                          const opt = document.createElement('option');
                          opt.textContent = 'Tidak ada siswa di kelas ini';
                          studentSelect.appendChild(opt);
                      }

                  } catch (err) {
                      console.error('Error memuat siswa:', err);
                      studentSelect.innerHTML = '<option value="">(Gagal memuat data)</option>';
                  }

              } else {
                  studentSelect.innerHTML = '<option value="">-- Pilih Nama --</option>';
              }
          });

          // --- tampilkan field tambahan sesuai tujuan ---
          tujuanSelect.addEventListener('change', function() {
              if (this.value === 'kbm') {
                  mapelField.style.display = 'block';
                  ketField.style.display = 'none';
              } else if (this.value === 'lainnya') {
                  mapelField.style.display = 'none';
                  ketField.style.display = 'block';
              } else {
                  mapelField.style.display = 'none';
                  ketField.style.display = 'none';
              }
          });
      });
      </script>
    </t>
  </template>
</odoo>
