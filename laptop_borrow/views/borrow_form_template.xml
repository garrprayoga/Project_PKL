<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <template id="borrow_form_template" name="Form Peminjaman Laptop">
    <t t-call="website.layout">
      <div class="container mt-5 mb-5">
        <h2>Form Peminjaman Laptop</h2>
        <form id="borrow-form" action="/form/peminjaman/submit" method="post">
          <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>

          <!-- KELAS -->
          <div class="form-group mt-2">
            <label>Kelas</label>
            <select id="class_id" name="class_id" class="form-control" required="required">
              <option value="">-- Pilih Kelas --</option>
              <t t-foreach="kelas" t-as="k">
                <option t-att-value="k.id"><t t-esc="k.name"/></option>
              </t>
            </select>
          </div>

          <!-- NAMA SISWA -->
          <div class="form-group mt-2">
            <label>Nama Siswa</label>
            <select id="borrower_id" name="borrower_id" class="form-control" required="required">
              <option value="">-- Pilih Nama --</option>
            </select>
          </div>

          <!-- TUJUAN -->
          <div class="form-group mt-2">
            <label>Tujuan Peminjaman</label>
            <select name="tujuan_peminjaman" id="tujuan_peminjaman" class="form-control" required="required">
              <option value="">-- Pilih Tujuan --</option>
              <option value="kbm">KBM</option>
              <option value="lainnya">Lainnya</option>
            </select>
          </div>

          <!-- GURU MAPEL -->
          <div class="form-group mt-2" id="mapel_field" style="display:none;">
            <label>Guru Mata Pelajaran</label>
            <input type="text" name="guru_mapel" class="form-control"/>
          </div>

          <!-- KETERANGAN -->
          <div class="form-group mt-2" id="keterangan_field" style="display:none;">
            <label>Keterangan</label>
            <textarea name="keterangan" class="form-control"></textarea>
          </div>

          <!-- JUMLAH -->
          <div class="form-group mt-3">
            <label>Jumlah Laptop</label>
            <input type="number" id="jumlah_pinjam" name="jumlah_pinjam" class="form-control" min="1" placeholder="Masukkan jumlah laptop yang ingin dipinjam" required="required"/>
          </div>

          <!-- LAPTOP -->
          <div class="form-group mt-3">
            <label class="form-label fw-bold">Pilih Laptop</label>
            <div class="list-group">
              <t t-foreach="laptop" t-as="l">
                <t t-if="l.is_laptop">
                  <label class="list-group-item d-flex align-items-center">
                    <input type="checkbox"
                           class="form-check-input me-2 laptop-checkbox"
                           name="laptop_id"
                           t-att-value="l.id"
                           t-att-id="'laptop_' + str(l.id)" />
                    <t t-esc="l.name"/>
                  </label>
                </t>
              </t>
            </div>
          </div>

          <button type="submit" class="btn btn-primary mt-3">Kirim</button>
        </form>
      </div>

      <!-- Script tambahan (AJAX + field toggle + limit checkbox) -->
      <script>
      document.addEventListener('DOMContentLoaded', function() {
          const classSelect = document.getElementById('class_id');
          const studentSelect = document.getElementById('borrower_id');
          const tujuanSelect = document.getElementById('tujuan_peminjaman');
          const mapelField = document.getElementById('mapel_field');
          const ketField = document.getElementById('keterangan_field');
          const jumlahInput = document.getElementById('jumlah_pinjam');
          const checkboxes = document.querySelectorAll('.laptop-checkbox');

          // ðŸ”¹ Load siswa by class
          classSelect.addEventListener('change', async function() {
              const classId = this.value;
              studentSelect.innerHTML = '<option value="">-- Memuat... --</option>';
              if (classId) {
                  try {
                      const response = await fetch('/get_students_by_class', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({ class_id: classId })
                      });
                      const students = await response.json();
                      studentSelect.innerHTML = '<option value="">-- Pilih Nama --</option>';
                      if (students.length > 0) {
                          students.forEach(s => {
                              const opt = document.createElement('option');
                              opt.value = s.id;
                              opt.textContent = s.name;
                              studentSelect.appendChild(opt);
                          });
                      } else {
                          studentSelect.innerHTML = '<option value="">(Tidak ada siswa)</option>';
                      }
                  } catch (err) {
                      console.error('Error:', err);
                      studentSelect.innerHTML = '<option value="">(Gagal memuat data)</option>';
                  }
              } else {
                  studentSelect.innerHTML = '<option value="">-- Pilih Nama --</option>';
              }
          });

          // ðŸ”¹ Toggle field berdasarkan tujuan
          tujuanSelect.addEventListener('change', function() {
              mapelField.style.display = this.value === 'kbm' ? 'block' : 'none';
              ketField.style.display = this.value === 'lainnya' ? 'block' : 'none';
          });

          // ðŸ”¹ Batasi checkbox sesuai jumlah
          function updateCheckboxLimit() {
              const maxAllowed = parseInt(jumlahInput.value) || 0;
              const checkedBoxes = document.querySelectorAll('.laptop-checkbox:checked');

              if (checkedBoxes.length >= maxAllowed) {
                  checkboxes.forEach(cb => {
                      if (!cb.checked) cb.disabled = true;
                  });
              } else {
                  checkboxes.forEach(cb => cb.disabled = false);
              }
          }

          jumlahInput.addEventListener('input', updateCheckboxLimit);
          checkboxes.forEach(cb => cb.addEventListener('change', updateCheckboxLimit));
      });
      </script>
    </t>
  </template>
</odoo>